<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<!-- Importazione librerie esterne -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
 body {
     font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background-color: #f8f9fa;
     padding: 20px;
 }
 
 .main-header {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     color: white;
     padding: 30px;
     border-radius: 15px;
     text-align: center;
     margin-bottom: 30px;
     box-shadow: 0 8px 25px rgba(0,0,0,0.15);
 }
 
 .section-card {
     background: white;
     border-radius: 12px;
     padding: 25px;
     margin-bottom: 25px;
     box-shadow: 0 4px 15px rgba(0,0,0,0.08);
     border-left: 4px solid #2a5298;
 }
 
 .section-title {
     color: #1e3c72;
     font-weight: 600;
     margin-bottom: 20px;
     padding-bottom: 10px;
     border-bottom: 2px solid #e9ecef;
 }
 
 .form-label {
     font-weight: 600;
     color: #495057;
     margin-bottom: 8px;
 }
 
 .form-control, .form-select {
     border-radius: 8px;
     border: 2px solid #e9ecef;
     padding: 12px 15px;
     font-size: 14px;
     transition: all 0.3s ease;
 }
 
 .form-control:focus, .form-select:focus {
     border-color: #2a5298;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .btn-primary {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     border: none;
     border-radius: 8px;
     padding: 12px 25px;
     font-weight: 600;
     transition: all 0.3s ease;
 }
 
 .btn-primary:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(42, 82, 152, 0.4);
 }
 
 .btn-success {
     background: linear-gradient(135deg, #28a745, #20c997);
     border: none;
     border-radius: 8px;
     padding: 8px 15px;
     font-weight: 600;
     transition: all 0.3s ease;
 }
 
 .btn-success:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
 }
 
 .btn-warning {
     background: linear-gradient(135deg, #ffc107, #ffb300);
     border: none;
     border-radius: 8px;
     padding: 8px 15px;
     font-weight: 600;
     transition: all 0.3s ease;
     color: #212529;
 }
 
 .btn-warning:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
     color: #212529;
 }
 
 .btn-info {
     background: linear-gradient(135deg, #17a2b8, #20c997);
     border: none;
     border-radius: 8px;
     padding: 12px 25px;
     font-weight: 600;
     transition: all 0.3s ease;
     color: white;
 }
 
 .btn-info:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
     color: white;
 }
 
 .calculated-field {
     background-color: #e7f3ff;
     border-color: #bee5eb;
     font-weight: 600;
 }
 
 .supplier-row {
     background-color: #f8f9fa;
     border-radius: 10px;
     padding: 20px;
     margin-bottom: 15px;
     border: 1px solid #dee2e6;
 }
 
 .bio-indicator {
     background-color: #d4edda;
     color: #155724;
     padding: 3px 8px;
     border-radius: 12px;
     font-size: 12px;
     font-weight: 600;
 }
 
 .bio-red-text {
     color: #dc3545 !important;
     font-weight: 600;
 }
 
 .bio-black-text {
     color: #000000 !important;
     font-weight: 600;
 }
 
 .bio-red-field {
     color: #dc3545 !important;
     font-weight: 600;
     border-color: #dc3545 !important;
 }
 
 .alert-info {
     border-left: 4px solid #0dcaf0;
     background-color: #cff4fc;
     border-radius: 8px;
 }
 
 .table th {
     background-color: #1e3c72;
     color: white;
     border: none;
     font-weight: 600;
 }
 
 .table td {
     vertical-align: middle;
     border-color: #e9ecef;
 }
 
 .progress {
     height: 8px;
     border-radius: 4px;
 }
 
 .hidden-field {
     display: none;
 }
 
 .time-display {
     font-family: 'Courier New', monospace;
     font-size: 16px;
     font-weight: bold;
     color: #1e3c72;
 }
 
 .yield-result {
     background-color: #e8f5e8;
     border-color: #28a745;
     font-weight: 600;
     text-align: center;
 }
 
 .revision-info {
     font-size: 12px;
     color: #6c757d;
     margin-top: 10px;
 }
 
 .supplier-selection {
     background-color: #e8f5e8;
     border: 2px solid #28a745;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }
 
 .next-day {
     color: #dc3545;
     font-weight: bold;
     font-size: 12px;
 }
 
 .combination-result {
     background-color: #fff3cd;
     border: 2px solid #ffc107;
     font-weight: bold;
     color: #856404;
 }
 
 .combination-row {
     background-color: #fff3cd !important;
     border: 2px solid #ffc107 !important;
 }
 
 .combination-individual-row {
     background-color: #fff3cd !important;
     border: 1px solid #ffc107 !important;
 }
 
 .auto-sum-field {
     background-color: #fffacd !important;
     border: 2px solid #ffd700 !important;
     font-weight: bold;
 }
 
 .note-field {
     min-height: 60px;
     resize: vertical;
 }
 
 .select2-container {
     width: 100% !important;
 }
 
 .select2-container--default .select2-selection--multiple {
     border: 2px solid #e9ecef;
     border-radius: 8px;
     min-height: 45px;
     padding: 5px;
 }
 
 .select2-container--default.select2-container--focus .select2-selection--multiple {
     border-color: #2a5298;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .sum-details {
     font-size: 11px;
     color: #856404;
     font-weight: normal;
     margin-top: 5px;
 }
 
 .combination-group {
     background-color: #f0f8ff;
     border: 2px solid #007bff;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }
 
 .combination-group-b {
     background-color: #f0fff0;
     border: 2px solid #28a745;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }

 /* Stili per modal Rese */
 .yields-modal {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background-color: rgba(0,0,0,0.5);
     display: none;
     z-index: 1000;
     overflow-y: auto;
 }
 
 .yields-content {
     position: relative;
     background-color: white;
     margin: 2% auto;
     padding: 20px;
     width: 90%;
     max-width: 1200px;
     min-height: 80%;
     border-radius: 15px;
 }
 
 .yields-header {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     color: white;
     padding: 20px;
     border-radius: 10px;
     margin-bottom: 20px;
     display: flex;
     justify-content: space-between;
     align-items: center;
 }
 
 .close-yields {
     color: white;
     font-size: 28px;
     font-weight: bold;
     cursor: pointer;
 }
 
 .close-yields:hover {
     color: #f0f0f0;
 }
 
 .yields-table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 20px;
 }
 
 .yields-table th {
     background-color: #1e3c72;
     color: white;
     padding: 15px;
     text-align: center;
     font-weight: 600;
     border: 1px solid #dee2e6;
 }
 
 .yields-table td {
     padding: 10px;
     text-align: center;
     border: 1px solid #dee2e6;
     vertical-align: middle;
 }
 
 .yields-table input[type="number"] {
     width: 80px;
     padding: 8px;
     border: 1px solid #ddd;
     border-radius: 4px;
     text-align: center;
     font-size: 14px;
 }
 
 .yields-table input[type="number"]:focus {
     border-color: #2a5298;
     outline: none;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .yields-section {
     margin-bottom: 30px;
     background-color: #f8f9fa;
     padding: 20px;
     border-radius: 10px;
     border-left: 4px solid #2a5298;
 }
 
 .yields-section h5 {
     color: #1e3c72;
     margin-bottom: 15px;
     font-weight: 600;
 }
 
 .agrume-display {
     background-color: #e7f3ff;
     border: 2px solid #2a5298;
     border-radius: 8px;
     padding: 15px;
     text-align: center;
     margin-bottom: 20px;
 }
 
 .agrume-display h4 {
     color: #1e3c72;
     margin: 0;
     font-weight: bold;
 }
</style>
</head>
<body>
<div class="container-fluid">
 <!-- Header principale -->
 <div class="main-header">
     <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
     <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
     <p class="mb-0">Data: <span id="current-date"></span></p>
     <div class="revision-info">
         Ultima revisione: <span id="last-revision"></span>
     </div>
 </div>

 <!-- Sezione Selezione Tipo Agrume -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-gear-fill"></i> Tipo di Agrume</h3>
     <div class="row">
         <div class="col-md-6">
             <label for="tipo-agrume-giornaliero" class="form-label">Seleziona Tipo di Agrume</label>
             <select class="form-select" id="tipo-agrume-giornaliero" required>
                 <option value="">Seleziona il tipo di agrume</option>
                 <option value="LIMONE">Limone</option>
                 <option value="ARANCIA">Arancia</option>
                 <option value="MANDARINO">Mandarino</option>
                 <option value="POMPELMO">Pompelmo</option>
                 <option value="BERGAMOTTO">Bergamotto</option>
             </select>
         </div>
         <div class="col-md-6">
             <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
             <input type="date" class="form-control" id="data-lavorazione" required>
         </div>
     </div>
 </div>

 <!-- Sezione Totali -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-boxes"></i> Quantità Totali</h3>
     <div class="row">
         <div class="col-md-4">
             <label for="entrata-giornaliera" class="form-label">Entrata Giornaliera Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="entrata-giornaliera" readonly>
         </div>
         <div class="col-md-4">
             <label for="trasformata-totale" class="form-label">Quantità trasformata Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="trasformata-totale" readonly>
         </div>
         <div class="col-md-4">
             <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="giacenza-totale" readonly>
         </div>
     </div>
 </div>

 <!-- Sezione Fornitori -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-truck"></i> Dettagli Fornitori e Lavorazione</h3>
     <div class="alert alert-info">
         <i class="bi bi-info-circle"></i> Aggiungi i fornitori e configura i parametri di lavorazione per ciascuno. L'orario di fine verrà calcolato automaticamente.
     </div>
     
     <div id="fornitori-container">
         <!-- I fornitori verranno aggiunti dinamicamente qui -->
     </div>
     
     <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
         <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
     </button>
 </div>

 <!-- Sezione Selezione Combinazioni Fornitori -->
 <div id="combinazioni-section" class="section-card hidden-field">
     <h3 class="section-title"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
     
     <!-- Combinazione A -->
     <div class="combination-group">
         <h5><i class="bi bi-diagram-2"></i> Combinazione A - Succo 1ª</h5>
         <div class="row">
             <div class="col-md-12">
                 <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª (fino a 3 fornitori)</label>
                 <select class="form-select" id="combinazione-fornitori-a">
                     <option value="">Seleziona combinazione A</option>
                     <!-- Opzioni generate dinamicamente -->
                 </select>
                 <div class="mt-3">
                     <button type="button" class="btn btn-success me-2" id="applica-combinazione-a">
                         <i class="bi bi-check-circle"></i> Applica Combinazione A
                     </button>
                     <button type="button" class="btn btn-warning" id="reset-combinazione-a">
                         <i class="bi bi-x-circle"></i> Reset Combinazione A
                     </button>
                     <small class="text-muted d-block mt-2">
                         Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione A
                     </small>
                 </div>
             </div>
         </div>
     </div>
     
     <!-- Combinazione B -->
     <div class="combination-group-b">
         <h5><i class="bi bi-diagram-3"></i> Combinazione B - Succo 1ª</h5>
         <div class="row">
             <div class="col-md-12">
                 <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª (fino a 3 fornitori)</label>
                 <select class="form-select" id="combinazione-fornitori-b">
                     <option value="">Seleziona combinazione B</option>
                     <!-- Opzioni generate dinamicamente -->
                 </select>
                 <div class="mt-3">
                     <button type="button" class="btn btn-success me-2" id="applica-combinazione-b">
                         <i class="bi bi-check-circle"></i> Applica Combinazione B
                     </button>
                     <button type="button" class="btn btn-warning" id="reset-combinazione-b">
                         <i class="bi bi-x-circle"></i> Reset Combinazione B
                     </button>
                     <small class="text-muted d-block mt-2">
                         Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione B
                     </small>
                 </div>
             </div>
         </div>
     </div>
 </div>

 <!-- Sezione Riepilogo Lavorazione -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-graph-up"></i> Riepilogo Programma Lavorazione</h3>
     <div class="table-responsive">
         <table class="table table-hover" id="riepilogo-table">
             <thead>
                 <tr>
                     <th>Fornitore</th>
                     <th>Q. Entrata (kg)</th>
                     <th>Q. Da trasformare (kg)</th>
                     <th>Giacenza (kg)</th>
                     <th>Certificazione</th>
                     <th>Varietà</th>
                     <th>Linea</th>
                     <th>Portata</th>
                     <th>Inizio</th>
                     <th>Fine</th>
                     <th>Durata</th>
                     <th>Dest.</th>
                     <th>Bio</th>
                     <th>Azioni</th>
                 </tr>
             </thead>
             <tbody>
                 <!-- Dati caricati dinamicamente -->
             </tbody>
         </table>
     </div>
 </div>

 <!-- Pulsanti di azione -->
 <div class="section-card text-center">
     <button type="button" class="btn btn-primary btn-lg me-3" id="rese-button">
         <i class="bi bi-bar-chart-line-fill"></i> Rese
     </button>
     <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="anteprima-stampa">
         <i class="bi bi-printer"></i> Anteprima Stampa
     </button>
     <button type="button" class="btn btn-outline-danger btn-lg" id="reset-programma">
         <i class="bi bi-arrow-clockwise"></i> Reset Programma
     </button>
 </div>
</div>

<!-- Modal Rese -->
<div id="yields-modal" class="yields-modal">
 <div class="yields-content">
     <div class="yields-header">
         <h2><i class="bi bi-bar-chart-line-fill"></i>
         Gestione Rese per Agrume</h2>
        <span class="close-yields">&times;</span>
    </div>
    
    <div class="agrume-display">
        <h4 id="agrume-selected">Nessun agrume selezionato</h4>
    </div>
    
    <div class="yields-section">
        <h5><i class="bi bi-droplet"></i> Rese Succo 1ª (%)</h5>
        <table class="yields-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Gen</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Apr</th>
                    <th>Mag</th>
                    <th>Giu</th>
                    <th>Lug</th>
                    <th>Ago</th>
                    <th>Set</th>
                    <th>Ott</th>
                    <th>Nov</th>
                    <th>Dic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Resa %</strong></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="1" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="2" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="3" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="4" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="5" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="6" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="7" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="8" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="9" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="10" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="11" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="prima" data-month="12" min="0" max="100" step="0.1"></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="yields-section">
        <h5><i class="bi bi-droplet"></i> Rese Succo 2ª (%)</h5>
        <table class="yields-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Gen</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Apr</th>
                    <th>Mag</th>
                    <th>Giu</th>
                    <th>Lug</th>
                    <th>Ago</th>
                    <th>Set</th>
                    <th>Ott</th>
                    <th>Nov</th>
                    <th>Dic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Resa %</strong></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="1" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="2" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="3" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="4" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="5" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="6" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="7" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="8" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="9" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="10" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="11" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="seconda" data-month="12" min="0" max="100" step="0.1"></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="yields-section">
        <h5><i class="bi bi-droplet"></i> Rese Torchiato (%)</h5>
        <table class="yields-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Gen</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Apr</th>
                    <th>Mag</th>
                    <th>Giu</th>
                    <th>Lug</th>
                    <th>Ago</th>
                    <th>Set</th>
                    <th>Ott</th>
                    <th>Nov</th>
                    <th>Dic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Resa %</strong></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="1" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="2" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="3" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="4" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="5" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="6" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="7" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="8" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="9" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="10" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="11" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="yield-input" data-type="torchiato" data-month="12" min="0" max="100" step="0.1"></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="text-center mt-4">
        <button type="button" class="btn btn-success btn-lg me-3" id="salva-rese">
            <i class="bi bi-save"></i> Salva Rese
        </button>
        <button type="button" class="btn btn-outline-secondary btn-lg" id="reset-rese">
            <i class="bi bi-arrow-clockwise"></i> Reset Valori
        </button>
    </div>
</div>
</div>

<!-- Template per fornitore -->
<div id="fornitore-template" class="hidden-field">
<div class="supplier-row" data-supplier-index="">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-building"></i> Fornitore <span class="supplier-number"></span></h5>
        <button type="button" class="btn btn-outline-danger btn-sm rimuovi-fornitore">
            <i class="bi bi-trash"></i> Rimuovi
        </button>
    </div>
    
    <div class="row g-3">
        <!-- Dati base fornitore -->
        <div class="col-md-3">
            <label class="form-label">Nome Fornitore</label>
            <select class="form-select nome-fornitore" required>
                <option value="">Seleziona fornitore</option>
                <option value="RESTUCCIA">RESTUCCIA</option>
                <option value="CI">CI</option>
                <option value="ARCO">ARCO</option>
                <option value="GIOVINAZZO">GIOVINAZZO</option>
                <option value="AZ.T.C.">AZ.T.C.</option>
                <option value="M.B.T.F.">M.B.T.F.</option>                  
                <option value="VASTA">VASTA</option>
                <option value="APAL">APAL</option> 
                <option value="GEIMA">GEIMA</option>
                <option value="UNIONBERG">UNIONBERG</option>                  
                <option value="ALTRO">ALTRO</option>
            </select>
            <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Quantità in Entrata (kg)</label>
            <input type="number" class="form-control quantita-fornitore" min="0" required>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Quantità trasformata (kg)</label>
            <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Giacenza (kg)</label>
            <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Certificazione Prodotto</label>
            <select class="form-select certificazione-prodotto" required>
                <option value="">Seleziona certificazione</option>
                <option value="BIO EU">BIO EU</option>
                <option value="BIO DEM">BIO DEM</option>
                <option value="BIO NTD">BIO NTD</option>
                <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                <option value="TRACCIATO">TRACCIATO</option>
                <option value="IGP">IGP</option>
                <option value="CONVENZIONALE">CONVENZIONALE</option>
                <option value="ALTRO">ALTRO</option>
            </select>
            <input type="text" class="form-control mt-2 altra-certificazione hidden-field" placeholder="Specifica altra certificazione">
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Varietà</label>
            <select class="form-select varieta-prodotto" required>
                <option value="">Seleziona varietà</option>
                <!-- Opzioni dinamiche in base al tipo di agrume -->
            </select>
            <input type="text" class="form-control mt-2 altra-varieta hidden-field" placeholder="Specifica altra varietà">
        </div>
        
        <!-- Parametri lavorazione -->
        <div class="col-md-4">
            <label class="form-label">Linea di Trasformazione</label>
            <select class="form-select linea-trasformazione" required>
                <option value="">Seleziona linea</option>
                <option value="BOE/1100">BOE/1100</option>
                <option value="GOE INT/POLY">GOE INT/POLY</option>
                <option value="GOE EST/POLY">GOE EST/POLY</option>
                <option value="GOE EST/400">GOE EST/400</option>
                <option value="B/SF">B/SF</option>
                <option value="TORCHI FASO">TORCHI FASO</option>
            </select>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Portata Impianto (kg/h)</label>
            <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Orario Inizio Lavorazione stimato</label>
            <input type="time" class="form-control orario-inizio" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Orario Fine Lavorazione stimato</label>
            <div class="orario-fine-display calculated-field form-control"></div>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Durata Lavorazione stimata</label>
            <input type="text" class="form-control calculated-field durata-lavorazione" readonly>
        </div>
    </div>
    
    <!-- Sezione Rese e Destinazioni -->
    <div class="mt-4">
        <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni Spremiture</h6>
        
        <div class="row g-3 mt-2">
            <!-- Rese percentuali -->
            <div class="col-md-4">
                <label class="form-label">Resa Succo 1ª (%)</label>
                <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" placeholder="Auto">
            </div>
            
            <div class="col-md-4 seconda-section">
               <label class="form-label">Resa Succo 2ª (%)</label>
               <input type="number" class="form-control resa-seconda" step="0.1" min="0" max="100" placeholder="Auto">
           </div>
           
           <div class="col-md-4">
               <label class="form-label">Resa Torchiato (%)</label>
              <input type="number" class="form-control resa-torchiato" step="0.1" min="0" max="100" placeholder="Auto">
          </div>
      </div>
      
      <!-- Risultati calcolo rese in kg -->
      <div class="row g-3 mt-2">
          <div class="col-md-4">
              <label class="form-label">Quantità Succo 1ª (kg)</label>
              <input type="number" class="form-control yield-result quantita-prima" readonly>
          </div>
          
          <div class="col-md-4 seconda-section">
              <label class="form-label">Quantità Succo 2ª (kg)</label>
              <input type="number" class="form-control yield-result quantita-seconda" readonly>
              <div class="sum-details seconda-details"></div>
          </div>
          
          <div class="col-md-4">
              <label class="form-label">Quantità Torchiato (kg)</label>
              <input type="number" class="form-control yield-result quantita-torchiato" readonly>
              <div class="sum-details torchiato-details"></div>
          </div>
      </div>
      
      <!-- Destinazioni spremiture -->
      <div class="row g-3 mt-3">
          <div class="col-md-4">
              <label class="form-label destinazione-prima-label">Destinazione Succo 1ª</label>
              <select class="form-select destinazione-prima" multiple>
                  <option value="NAT IN TINI">NAT IN TINI</option>
                  <option value="PET 100">PET 100</option>
                  <option value="PET 200">PET 200</option>
                  <option value="PET 480">PET 480</option>
                  <option value="ACMA">ACMA</option>
                  <option value="REX">REX</option>
                  <option value="GOGLIO">GOGLIO</option>
                  <option value="VASCHETTE">VASCHETTE</option>
                  <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                 <option value="LATTE">LATTE</option>
                 <option value="F.F.">F.F.</option>
                 <option value="F.T.C">F.T.C</option>
                 <option value="FBL">FBL</option>
                 <option value="BIC">BIC</option>
                 <option value="CISTERNA P">CISTERNA P</option>
                 <option value="CISTERNA EF">CISTERNA EF</option>
                 <option value="CISTERNA VK">CISTERNA VK</option>
                 <option value="CISTERNA GS">CISTERNA GS</option>
                 <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                 <option value="CONCENTRATO">CONCENTRATO</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
         </div>
         
         <div class="col-md-4 seconda-section">
             <label class="form-label">Destinazione Succo 2ª</label>
             <select class="form-select destinazione-seconda">
                 <option value="">Seleziona destinazione</option>
                 <option value="NAT IN TINI" selected>NAT IN TINI</option>
                 <option value="CONCENTRATO">CONCENTRATO</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
         </div>
         
         <div class="col-md-4">
             <label class="form-label">Destinazione Torchiato</label>
             <select class="form-select destinazione-torchiato">
                 <option value="">Seleziona destinazione</option>
                 <option value="NAT IN TINI">NAT IN TINI</option>
                 <option value="F.F.">F.F.</option>
                 <option value="F.T.C">F.T.C</option>
                 <option value="FBL">FBL</option>
                 <option value="BIC">BIC</option>
                 <option value="CONCENTRATO" selected>CONCENTRATO</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
         </div>
     </div>
     
     <!-- Pastorizzazione -->
     <div class="row g-3 mt-3">
         <div class="col-md-4">
             <label class="form-label">Pastorizzato</label>
             <select class="form-select pastorizzato-prima">
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
             </select>
         </div>
         
         <div class="col-md-4 seconda-section">
             <label class="form-label">Pastorizzato</label>
             <select class="form-select pastorizzato-seconda">
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
             </select>
         </div>
         
         <div class="col-md-4">
             <label class="form-label">Pastorizzato</label>
             <select class="form-select pastorizzato-torchiato">
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
             </select>
         </div>
     </div>
     
     <!-- Tenore di polpa, Brix e Bio per ogni prodotto -->
     <div class="row g-3 mt-3">
         <div class="col-md-4">
             <label class="form-label">Tenore Polpa Succo 1ª</label>
             <select class="form-select tenore-polpa-prima">
                 <option value="STANDARD">STANDARD</option>
                 <option value="LIMPIDO">LIMPIDO</option>
                 <option value="SEMICLEAR">SEMICLEAR</option>
                 <option value="<1%"><1%</option>
                 <option value="2%">2%</option>
                 <option value="3%">3%</option>
                 <option value="6%">6%</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-tenore-prima hidden-field" placeholder="Specifica altro tenore">
             
             <label class="form-label mt-2">Brix</label>
             <select class="form-select brix-prima">
                 <option value="NAT">NAT</option>
                 <option value="20">20</option>
                 <option value="32">32</option>
                 <option value="40">40</option>
                 <option value="41">41</option>
                 <option value="45">45</option>
                 <option value="55">55</option>
                 <option value="58">58</option>
                 <option value="60">60</option>
                 <option value="63.5">63.5</option>
                 <option value="65">65</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-brix-prima hidden-field" placeholder="Specifica altro Brix">
             
             <label class="form-label mt-2">Biologico</label>
             <select class="form-select bio-prima">
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
                 <option value="DECLASSATO">DECLASSATO</option>
             </select>
             
             <label class="form-label mt-2">Conservato</label>
             <select class="form-select conservato-prima">
                 <option value="SI">SI</option>
                 <option value="NO" selected>NO</option>
             </select>
             
             <label class="form-label mt-2">Note</label>
             <textarea class="form-control note-field note-prima" placeholder="Inserisci note per Succo 1ª"></textarea>
         </div>
         
         <div class="col-md-4 seconda-section">
             <label class="form-label">Tenore Polpa Succo 2ª</label>
             <select class="form-select tenore-polpa-seconda">
                 <option value="STANDARD">STANDARD</option>
                 <option value="LIMPIDO">LIMPIDO</option>
                 <option value="SEMICLEAR">SEMICLEAR</option>
                 <option value="<1%" selected><1%</option>
                 <option value="2%">2%</option>
                 <option value="3%">3%</option>
                 <option value="6%">6%</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-tenore-seconda hidden-field" placeholder="Specifica altro tenore">
             
             <label class="form-label mt-2">Brix</label>
             <select class="form-select brix-seconda">
                 <option value="NAT">NAT</option>
                 <option value="20">20</option>
                 <option value="32">32</option>
                 <option value="40">40</option>
                 <option value="41">41</option>
                 <option value="45">45</option>
                 <option value="55">55</option>
                 <option value="58">58</option>
                 <option value="60">60</option>
                 <option value="63.5">63.5</option>
                 <option value="65">65</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-brix-seconda hidden-field" placeholder="Specifica altro Brix">
             
             <label class="form-label mt-2">Conservato</label>
             <select class="form-select conservato-seconda">
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
             </select>
             
             <label class="form-label mt-2">Note</label>
             <textarea class="form-control note-field note-seconda" placeholder="Inserisci note per Succo 2ª"></textarea>
         </div>
         
         <div class="col-md-4">
             <label class="form-label">Tenore Polpa Torchiato</label>
             <select class="form-select tenore-polpa-torchiato">
                 <option value="STANDARD">STANDARD</option>
                 <option value="LIMPIDO">LIMPIDO</option>
                 <option value="SEMICLEAR">SEMICLEAR</option>
                 <option value="<1%" selected><1%</option>
                 <option value="2%">2%</option>
                 <option value="3%">3%</option>
                 <option value="6%">6%</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-tenore-torchiato hidden-field" placeholder="Specifica altro tenore">
             
             <label class="form-label mt-2">Brix</label>
             <select class="form-select brix-torchiato">
                 <option value="NAT">NAT</option>
                 <option value="20">20</option>
                 <option value="32">32</option>
                 <option value="40">40</option>
                 <option value="41">41</option>
                 <option value="45" selected>45</option>
                 <option value="55">55</option>
                 <option value="58">58</option>
                 <option value="60">60</option>
                 <option value="63.5">63.5</option>
                 <option value="65">65</option>
                 <option value="ALTRO">ALTRO</option>
             </select>
             <input type="text" class="form-control mt-2 altro-brix-torchiato hidden-field" placeholder="Specifica altro Brix">
             
             <label class="form-label mt-2">Conservato</label>
             <select class="form-select conservato-torchiato">
                 <option value="SI">SI</option>
                 <option value="NO" selected>NO</option>
             </select>
             
             <label class="form-label mt-2">Note</label>
             <textarea class="form-control note-field note-torchiato" placeholder="Inserisci note per Torchiato"></textarea>
         </div>
     </div>
 </div>
</div>
</div>

<script>
$(document).ready(function() {
 let supplierCount = 0;
 let programData = {};
 
 // Variabili per le combinazioni - MODIFICATE per supportare A e B
 let lastCombinationSuppliersA = '';
 let combinationDetailsA = [];
 let combinationSupplierIndexesA = [];
 
 let lastCombinationSuppliersB = '';
 let combinationDetailsB = [];
 let combinationSupplierIndexesB = [];
 
 let sumDetailsSeconda = {};
 let sumDetailsTorchiato = {};
 
 // Variabili per gestione rese
 let yieldsData = {};
 
 // Definizione varietà per ogni tipo di agrume
 const varietyOptions = {
     'LIMONE': [
         {
           value: 'VERDELLO', text: 'Verdello' },
         { value: 'FEMMINELLO', text: 'Femminello' },
         { value: 'INTERDONATO', text: 'Interdonato' },
         { value: 'BIANCHETTO', text: 'Bianchetto' },
         { value: 'MONACHELLO', text: 'Monachello' },
         { value: 'VARIE', text: 'Varie' },
         { value: 'ALTRO', text: 'Altro (specifica quale)' }
     ],
     'MANDARINO': [
         { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
         { value: 'AVANA', text: 'Avana' },
         { value: 'CLEMENTINO', text: 'Clementino' },
         { value: 'VARIE', text: 'Varie' },
         { value: 'ALTRO', text: 'Altro (specifica quale)' }
     ],
     'ARANCIA': [
         { value: 'BIONDA', text: 'Bionda' },
         { value: 'MORO', text: 'Moro' },
         { value: 'SANGUINELLA', text: 'Sanguinella' },
         { value: 'TAROCCO', text: 'Tarocco' },
         { value: 'VARIE', text: 'Varie' },
         { value: 'ALTRO', text: 'Altro (specifica quale)' }
     ],
     'BERGAMOTTO': [
         { value: 'FEMMINELLO', text: 'Femminello' },
         { value: 'CASTAGNARO', text: 'Castagnaro' },
         { value: 'VARIE', text: 'Varie' },
         { value: 'ALTRO', text: 'Altro (specifica quale)' }
     ],
     'POMPELMO': [
         { value: 'GIALLO', text: 'Giallo' },
         { value: 'ROSA', text: 'Rosa' },
         { value: 'VARIE', text: 'Varie' },
         { value: 'ALTRO', text: 'Altro (specifica quale)' }
     ]
 };
 
 // Inizializzazione data corrente e ultima revisione
 function initCurrentDate() {
     const today = new Date();
     const formatted = today.toLocaleDateString('it-IT', {
         weekday: 'long',
         year: 'numeric',
         month: 'long',
         day: 'numeric'
     });
     $('#current-date').text(formatted);
     $('#data-lavorazione').val(today.toISOString().split('T')[0]);
     
     updateLastRevision();
 }
 
 // Aggiorna ultima revisione
 function updateLastRevision() {
     const now = new Date();
     const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
     $('#last-revision').text(lastRevision);
 }
 
 // Aggiorna opzioni varietà in base al tipo di agrume selezionato
 function updateVarietyOptions(supplierElement, tipoAgrume) {
     const varietaSelect = supplierElement.find('.varieta-prodotto');
     const currentValue = varietaSelect.val();
     
     varietaSelect.empty();
     varietaSelect.append('<option value="">Seleziona varietà</option>');
     
     if (tipoAgrume && varietyOptions[tipoAgrume]) {
         varietyOptions[tipoAgrume].forEach(function(variety) {
             varietaSelect.append(`<option value="${variety.value}">${variety.text}</option>`);
         });
     }
     
     // Ripristina il valore precedente se ancora valido
     if (currentValue) {
         varietaSelect.val(currentValue);
     }
 }
 
 // Calcolo automatico rese in base al tipo di agrume
 function calculateAutoYields(agrume) {
     const yields = {
         'LIMONE': { prima: 32, seconda: 5, torchiato: 6 },
         'ARANCIA': { prima: 35, seconda: 12, torchiato: 6 },
         'MANDARINO': { prima: 42, seconda: 10, torchiato: 4 },
         'POMPELMO': { prima: 30, seconda: 15, torchiato: 6 },
         'BERGAMOTTO': { prima: 30, seconda: 8, torchiato: 3 }
     };
     return yields[agrume] || { prima: 45, seconda: 10, torchiato: 4 };
 }
 
 // Gestione visibilità sezione succo 2ª in base alla linea
 function toggleSecondaSection(supplierElement) {
     const linea = supplierElement.find('.linea-trasformazione').val();
     const secondaSections = supplierElement.find('.seconda-section');
     
     if (linea === 'BOE/1100') {
         secondaSections.removeClass('hidden-field');
     } else {
         secondaSections.addClass('hidden-field');
         // Reset dei valori quando nascosta
         supplierElement.find('.resa-seconda').val('');
         supplierElement.find('.quantita-seconda').val('');
         supplierElement.find('.destinazione-seconda').val('NAT IN TINI');
         supplierElement.find('.pastorizzato-seconda').val('SI');
         supplierElement.find('.tenore-polpa-seconda').val('<1%');
         supplierElement.find('.brix-seconda').val('NAT');
         supplierElement.find('.conservato-seconda').val('SI');
         supplierElement.find('.note-seconda').val('SERB. ESTERNI');
     }
 }
 
 // Mostra/nasconde sezione combinazioni
 function toggleCombinazioniSection() {
     const hasSuppliers = $('.supplier-row').length > 0;
     
     if (hasSuppliers) {
         $('#combinazioni-section').removeClass('hidden-field');
     } else {
         $('#combinazioni-section').addClass('hidden-field');
     }
 }
 
 // Aggiorna opzioni select per combinazioni fornitori - MODIFICATA per A e B
 function updateCombinazioneOptions() {
     const selectA = $('#combinazione-fornitori-a');
     const selectB = $('#combinazione-fornitori-b');
     
     selectA.empty().append('<option value="">Seleziona combinazione A</option>');
     selectB.empty().append('<option value="">Seleziona combinazione B</option>');
     
     const fornitori = [];
     $('.supplier-row').each(function() {
         const index = $(this).data('supplier-index');
         const fornitore = $(this).find('.nome-fornitore').val() || '';
         const altroFornitore = $(this).find('.altro-fornitore').val();
         const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
         const certificazione = $(this).find('.certificazione-prodotto').val() || 'N/D';
         const lineaTrasformazione = $(this).find('.linea-trasformazione').val() || 'N/D';
         
         if (nomeFornitore) {
             fornitori.push({ 
                 index: index, 
                 nome: nomeFornitore,
                 certificazione: certificazione,
                 linea: lineaTrasformazione
             });
         }
     });
     
     // Combinazioni di 2 fornitori
     for (let i = 0; i < fornitori.length; i++) {
         for (let j = i + 1; j < fornitori.length; j++) {
             const combo = `${fornitori[i].index},${fornitori[j].index}`;
             const label = `F${fornitori[i].index} - ${fornitori[i].nome} [${fornitori[i].certificazione}|${fornitori[i].linea}] + F${fornitori[j].index} - ${fornitori[j].nome} [${fornitori[j].certificazione}|${fornitori[j].linea}]`;
             selectA.append(`<option value="${combo}">${label}</option>`);
             selectB.append(`<option value="${combo}">${label}</option>`);
         }
     }
     
     // Combinazioni di 3 fornitori
     for (let i = 0; i < fornitori.length; i++) {
         for (let j = i + 1; j < fornitori.length; j++) {
             for (let k = j + 1; k < fornitori.length; k++) {
                 const combo = `${fornitori[i].index},${fornitori[j].index},${fornitori[k].index}`;
                 const label = `F${fornitori[i].index} - ${fornitori[i].nome} [${fornitori[i].certificazione}|${fornitori[i].linea}] + F${fornitori[j].index} - ${fornitori[j].nome} [${fornitori[j].certificazione}|${fornitori[j].linea}] + F${fornitori[k].index} - ${fornitori[k].nome} [${fornitori[k].certificazione}|${fornitori[k].linea}]`;
                 selectA.append(`<option value="${combo}">${label}</option>`);
                 selectB.append(`<option value="${combo}">${label}</option>`);
             }
         }
     }
 }
 
 // Trova l'ultimo fornitore incluso in una combinazione
 function getLastSupplierInCombination(comboValue) {
     const indexes = comboValue.split(',').map(i => parseInt(i));
     const maxIndex = Math.max(...indexes);
     return $(`[data-supplier-index="${maxIndex}"]`);
 }
 
 // Trova l'ultimo fornitore
 function getLastSupplier() {
     let lastSupplier = null;
     let maxIndex = 0;
     
     $('.supplier-row').each(function() {
         const index = parseInt($(this).attr('data-supplier-index'));
         if (index > maxIndex) {
             maxIndex = index;
             lastSupplier = $(this);
         }
     });
     
     return lastSupplier;
 }
 
 // Calcola dettagli somma per ogni fornitore (solo per linee BOE/1100)
 function calculateSumDetails() {
     const suppliers = $('.supplier-row');
     const details = [];
     
     suppliers.each(function() {
         const nome = $(this).find('.nome-fornitore').val();
         const altroNome = $(this).find('.altro-fornitore').val();
         const nomeFornitore = nome === 'ALTRO' ? altroNome : nome;
         const linea = $(this).find('.linea-trasformazione').val();
         
         const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
         const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
         const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
         
         if (nomeFornitore && quantitaTrasformata > 0) {
             const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
             const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
             
             details.push({
                 nome: nomeFornitore,
                 linea: linea,
                 seconda: qtaSeconda,
                 torchiato: qtaTorchiato
             });
         }
     });
     
     return details;
 }
 
 // Formatta dettagli somma
 function formatSumDetails(details, type) {
     if (details.length <= 1) return '';
     
     const parts = details.map(d => `${d.nome} = ${d[type]} kg`);
     return parts.join(' + ');
 }
 
 // Aggiorna somme automatiche per l'ultimo fornitore
 function updateAutoSums() {
     const suppliers = $('.supplier-row');
     if (suppliers.length === 0) return;
     
     const lastSupplier = getLastSupplier();
     
     if (suppliers.length === 1) {
         // Con un solo fornitore, calcola normalmente
         const quantitaTrasformata = parseFloat(lastSupplier.find('.quantita-trasformata').val()) || 0;
         const resaSeconda = parseFloat(lastSupplier.find('.resa-seconda').val()) || 0;
         const resaTorchiato = parseFloat(lastSupplier.find('.resa-torchiato').val()) || 0;
         const linea = lastSupplier.find('.linea-trasformazione').val();
         
         const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
         const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
         
         lastSupplier.find('.quantita-seconda').val(qtaSeconda).removeClass('auto-sum-field');
         lastSupplier.find('.quantita-torchiato').val(qtaTorchiato).removeClass('auto-sum-field');
         lastSupplier.find('.seconda-details').html('');
         lastSupplier.find('.torchiato-details').html('');
         
         // Rimuovi gli stili da tutti
         suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
     } else {
         // Con più fornitori, calcola le somme
         let totalSeconda = 0;
         let totalTorchiato = 0;
         
         suppliers.each(function() {
             const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
             const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
             const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
             const linea = $(this).find('.linea-trasformazione').val();
             
             if (quantitaTrasformata > 0) {
                 if (linea === 'BOE/1100') {
                     totalSeconda += (quantitaTrasformata * resaSeconda / 100);
                 }
                 totalTorchiato += (quantitaTrasformata * resaTorchiato / 100);
             }
         });
         
         // Rimuovi gli stili da tutti i fornitori
         suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
         suppliers.find('.seconda-details, .torchiato-details').html('');
         
         // Calcola i valori individuali per gli altri fornitori
         suppliers.not(lastSupplier).each(function() {
             const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
             const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
             const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
             const linea = $(this).find('.linea-trasformazione').val();
             
             const qtaSeconda = linea === 'BOE/1100' ? (quantitaTrasformata * resaSeconda / 100).toFixed(1) : '0';
             const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
             
             $(this).find('.quantita-seconda').val(qtaSeconda);
             $(this).find('.quantita-torchiato').val(qtaTorchiato);
         });
         
         // Applica le somme solo all'ultimo fornitore
         lastSupplier.find('.quantita-seconda').val(totalSeconda.toFixed(1)).addClass('auto-sum-field');
         lastSupplier.find('.quantita-torchiato').val(totalTorchiato.toFixed(1)).addClass('auto-sum-field');
         
         // Aggiungi dettagli somma
         const details = calculateSumDetails();
         const secondaDetails = formatSumDetails(details.filter(d => d.linea === 'BOE/1100'), 'seconda');
         const torchiatoDetails = formatSumDetails(details, 'torchiato');
         
         if (secondaDetails) {
             lastSupplier.find('.seconda-details').html(`<strong>Dettaglio:</strong> ${secondaDetails}`);
         }
         if (torchiatoDetails) {
             lastSupplier.find('.torchiato-details').html(`<strong>Dettaglio:</strong> ${torchiatoDetails}`);
         }
         
         // Salva i dettagli globalmente
         sumDetailsSeconda = details.filter(d => d.linea === 'BOE/1100');
         sumDetailsTorchiato = details;
     }
   }
 
 // Ottieni nomi fornitori dalla combinazione
 function getSupplierNamesFromCombo(comboValue) {
     const indexes = comboValue.split(',');
     const names = [];
     
     indexes.forEach(index => {
         const supplierRow = $(`[data-supplier-index="${index}"]`);
         const fornitore = supplierRow.find('.nome-fornitore').val() || '';
         const altroFornitore = supplierRow.find('.altro-fornitore').val();
         const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
         if (nomeFornitore) {
             names.push(nomeFornitore);
         }
     });
     
     return names.join(' + ');
 }
 
 // Applica combinazione - MODIFICATA per supportare A e B
 function applyCombination(type) {
     const selectedCombo = $(`#combinazione-fornitori-${type}`).val();
     if (!selectedCombo) {
         alert(`Seleziona prima una combinazione di fornitori ${type.toUpperCase()}`);
         return;
     }
     
     const indexes = selectedCombo.split(',');
     let totale = 0;
     let combinationDetails = []; // Array dettagli per questa combinazione
     let combinationSupplierIndexes = indexes.map(i => parseInt(i)); // Indici fornitori
     
     indexes.forEach(index => {
         const supplierRow = $(`[data-supplier-index="${index}"]`);
         
         // Raccogli informazioni complete del fornitore
         const fornitore = supplierRow.find('.nome-fornitore').val() || '';
         const altroFornitore = supplierRow.find('.altro-fornitore').val();
         const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
         const certificazione = supplierRow.find('.certificazione-prodotto').val() || 'N/D';
         const lineaTrasformazione = supplierRow.find('.linea-trasformazione').val() || 'N/D';
         
         const quantitaTrasformata = parseFloat(supplierRow.find('.quantita-trasformata').val()) || 0;
         const resaPrima = parseFloat(supplierRow.find('.resa-prima').val()) || 0;
         
         if (quantitaTrasformata > 0) {
             totale += (quantitaTrasformata * resaPrima / 100);
             
             // Aggiungi dettagli completi del fornitore
             combinationDetails.push({
                 nome: nomeFornitore,
                 certificazione: certificazione,
                 linea: lineaTrasformazione,
                 quantita: quantitaTrasformata,
                 resa: resaPrima,
                 risultato: (quantitaTrasformata * resaPrima / 100).toFixed(1),
                 supplierIndex: parseInt(index)
             });
         }
     });
     
     const lastSupplierInCombo = getLastSupplierInCombination(selectedCombo);
     if (lastSupplierInCombo.length > 0) {
         const quantitaPrimaField = lastSupplierInCombo.find('.quantita-prima');
         quantitaPrimaField.val(totale.toFixed(1));
         quantitaPrimaField.addClass('combination-result');
         quantitaPrimaField.attr('data-combination-type', type); // Marca il tipo di combinazione
         
         // Crea testo dettagliato della combinazione
         const detailedCombination = combinationDetails.map(detail => 
             `F${detail.supplierIndex} - ${detail.nome} [${detail.certificazione}|${detail.linea}] = ${detail.risultato}kg`
         ).join(' + ');
         
         // Salva variabili specifiche per tipo
         if (type === 'a') {
             lastCombinationSuppliersA = combinationDetails.map(detail => detail.nome).join(' + ');
             combinationDetailsA = combinationDetails;
             combinationSupplierIndexesA = combinationSupplierIndexes;
         } else {
             lastCombinationSuppliersB = combinationDetails.map(detail => detail.nome).join(' + ');
             combinationDetailsB = combinationDetails;
             combinationSupplierIndexesB = combinationSupplierIndexes;
         }
         
         const noteElement = lastSupplierInCombo.find('.combination-note');
         if (noteElement.length === 0) {
             quantitaPrimaField.after(`<small class="combination-note text-warning d-block" style="font-size: 11px; line-height: 1.2;">Valore da combinazione ${type.toUpperCase()} fornitori:<br/>${detailedCombination}</small>`);
         } else {
             noteElement.html(`Valore da combinazione ${type.toUpperCase()} fornitori:<br/>${detailedCombination}`);
         }
         
         alert(`Combinazione ${type.toUpperCase()} applicata! Quantità succo 1ª dell'ultimo fornitore incluso aggiornata a ${totale.toFixed(1)} kg\n\nDettaglio combinazione ${type.toUpperCase()}:\n${combinationDetails.map(d => `F${d.supplierIndex} - ${d.nome} [${d.certificazione}|${d.linea}]: ${d.quantita}kg × ${d.resa}% = ${d.risultato}kg`).join('\n')}`);
         
         // Aggiorna tabella riepilogo
         updateSummaryTable();
     } else {
         alert('Nessun fornitore disponibile per applicare la combinazione');
     }
 }
 
 // Reset combinazione - MODIFICATA per supportare A e B
 function resetCombination(type) {
     $('.supplier-row').each(function() {
         const quantitaPrimaField = $(this).find('.quantita-prima');
         const combinationType = quantitaPrimaField.attr('data-combination-type');
         
         if (quantitaPrimaField.hasClass('combination-result') && combinationType === type) {
             // Rimuovi la classe combination-result
             quantitaPrimaField.removeClass('combination-result');
             quantitaPrimaField.removeAttr('data-combination-type');
             
             // Rimuovi la nota di combinazione
             $(this).find('.combination-note').remove();
             
             // Ricalcola il valore basandosi sulla resa
             calculateYieldQuantities($(this));
         }
     });
     
     // Reset del select combinazioni
     $(`#combinazione-fornitori-${type}`).val('');
     
     // Reset delle variabili memorizzate
     if (type === 'a') {
         lastCombinationSuppliersA = '';
         combinationDetailsA = [];
         combinationSupplierIndexesA = [];
     } else {
         lastCombinationSuppliersB = '';
         combinationDetailsB = [];
         combinationSupplierIndexesB = [];
     }
     
     alert(`Combinazione ${type.toUpperCase()} rimossa. I valori del succo 1ª sono stati ricalcolati in base alle rese.`);
     
     // Aggiorna tabella riepilogo
     updateSummaryTable();
 }
 
 // Aggiorna stili BIO per certificazione, varietà e linea
 function updateBioStyles(supplierElement) {
     const certificazione = supplierElement.find('.certificazione-prodotto').val();
     const certificazioneField = supplierElement.find('.certificazione-prodotto');
     const varietaField = supplierElement.find('.varieta-prodotto');
     const lineaField = supplierElement.find('.linea-trasformazione');
     
     certificazioneField.removeClass('bio-red-field');
     varietaField.removeClass('bio-red-field');
     lineaField.removeClass('bio-red-field');
     
     if (['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(certificazione)) {
         certificazioneField.addClass('bio-red-field');
         varietaField.addClass('bio-red-field');
         lineaField.addClass('bio-red-field');
     }
 }
 
 // Aggiunta nuovo fornitore
 function addSupplier() {
     supplierCount++;
     const template = $('#fornitore-template').html();
     const newSupplier = $(template);
     
     newSupplier.attr('data-supplier-index', supplierCount);
     newSupplier.find('.supplier-number').text(supplierCount);
     
     const agrume = $('#tipo-agrume-giornaliero').val();
     if (agrume) {
         const yields = calculateAutoYields(agrume);
         newSupplier.find('.resa-prima').val(yields.prima);
         newSupplier.find('.resa-seconda').val(yields.seconda);
         newSupplier.find('.resa-torchiato').val(yields.torchiato);
         
         // Aggiorna opzioni varietà in base al tipo di agrume
         updateVarietyOptions(newSupplier, agrume);
     }
     
     $('#fornitori-container').append(newSupplier);
     
     // Inizializza Select2 per destinazione multipla
     newSupplier.find('.destinazione-prima').select2({
         placeholder: "Seleziona fino a 3 destinazioni",
         maximumSelectionLength: 3,
         language: {
             maximumSelected: function() {
                 return "Puoi selezionare massimo 3 destinazioni";
             }
         }
     });
     
     // Nascondi inizialmente la sezione succo 2ª
     newSupplier.find('.seconda-section').addClass('hidden-field');
     
     attachSupplierEvents(newSupplier);
     updateCombinazioneOptions();
     toggleCombinazioniSection();
     updateAutoSums();
 }
 
 // Eventi per ogni fornitore
 function attachSupplierEvents(supplierElement) {
     const index = supplierElement.data('supplier-index');
     
     // Gestione campo "ALTRO" per fornitore
     supplierElement.find('.nome-fornitore').change(function() {
         const altroField = supplierElement.find('.altro-fornitore');
         if ($(this).val() === 'ALTRO') {
             altroField.removeClass('hidden-field');
         } else {
             altroField.addClass('hidden-field').val('');
         }
         updateSummaryTable();
         updateCombinazioneOptions();
     });
     
     // Altri eventi del fornitore (abbreviati per spazio) - includere tutti gli eventi originali
     // ... [resto degli eventi del fornitore]
 }
 
 // Raccolta dati programma
 function collectProgramData() {
     const data = {
         tipoAgrume: $('#tipo-agrume-giornaliero').val(),
         dataLavorazione: $('#data-lavorazione').val(),
         entrataGiornaliera: parseFloat($('#entrata-giornaliera').val()) || 0,
         trasformataTotale: parseFloat($('#trasformata-totale').val()) || 0,
         giacenzaTotale: parseFloat($('#giacenza-totale').val()) || 0,
         ultimaRevisione: $('#last-revision').text(),
         fornitori: []
     };
     
     $('.supplier-row').each(function() {
         // Raccogli dati completi fornitore
       const fornitoreData = {
             index: $(this).data('supplier-index'),
             nome: $(this).find('.nome-fornitore').val(),
             altroNome: $(this).find('.altro-fornitore').val(),
             quantitaEntrata: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
             quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
             giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
             certificazione: $(this).find('.certificazione-prodotto').val(),
             altraCertificazione: $(this).find('.altra-certificazione').val(),
             varieta: $(this).find('.varieta-prodotto').val(),
             altraVarieta: $(this).find('.altra-varieta').val(),
             lineaTrasformazione: $(this).find('.linea-trasformazione').val(),
             portataImpianto: parseFloat($(this).find('.portata-impianto').val()) || 0,
             orarioInizio: $(this).find('.orario-inizio').val(),
             orarioFine: $(this).find('.orario-fine-display').text(),
             durataLavorazione: $(this).find('.durata-lavorazione').val(),
             // Rese
             resaPrima: parseFloat($(this).find('.resa-prima').val()) || 0,
             resaSeconda: parseFloat($(this).find('.resa-seconda').val()) || 0,
             resaTorchiato: parseFloat($(this).find('.resa-torchiato').val()) || 0,
             // Quantità prodotte
             quantitaPrima: parseFloat($(this).find('.quantita-prima').val()) || 0,
             quantitaSeconda: parseFloat($(this).find('.quantita-seconda').val()) || 0,
             quantitaTorchiato: parseFloat($(this).find('.quantita-torchiato').val()) || 0,
             // Destinazioni
             destinazionePrima: $(this).find('.destinazione-prima').val(),
             altraDestinazionePrima: $(this).find('.altra-destinazione').val(),
             destinazioneSeconda: $(this).find('.destinazione-seconda').val(),
             destinazioneTorchiato: $(this).find('.destinazione-torchiato').val(),
             // Pastorizzazione
             pastorizzatoPrima: $(this).find('.pastorizzato-prima').val(),
             pastorizzatoSeconda: $(this).find('.pastorizzato-seconda').val(),
             pastorizzatoTorchiato: $(this).find('.pastorizzato-torchiato').val(),
             // Caratteristiche prodotto
             tenorePolpaPrima: $(this).find('.tenore-polpa-prima').val(),
             altroTenorePrima: $(this).find('.altro-tenore-prima').val(),
             tenorePolpaSeconda: $(this).find('.tenore-polpa-seconda').val(),
             tenorePolpaTorchiato: $(this).find('.tenore-polpa-torchiato').val(),
             brixPrima: $(this).find('.brix-prima').val(),
             altroBrixPrima: $(this).find('.altro-brix-prima').val(),
             brixSeconda: $(this).find('.brix-seconda').val(),
             brixTorchiato: $(this).find('.brix-torchiato').val(),
             bioPrima: $(this).find('.bio-prima').val(),
             conservatoPrima: $(this).find('.conservato-prima').val(),
             conservatoSeconda: $(this).find('.conservato-seconda').val(),
             conservatoTorchiato: $(this).find('.conservato-torchiato').val(),
             // Note
             notePrima: $(this).find('.note-prima').val(),
             noteSeconda: $(this).find('.note-seconda').val(),
             noteTorchiato: $(this).find('.note-torchiato').val(),
             // Informazioni combinazione
             isCombinationResult: $(this).find('.quantita-prima').hasClass('combination-result'),
             combinationType: $(this).find('.quantita-prima').attr('data-combination-type')
         };
         
         data.fornitori.push(fornitoreData);
     });
     
     // Aggiungi informazioni combinazioni
     data.combinazioneA = {
         attiva: combinationDetailsA.length > 0,
         dettagli: combinationDetailsA,
         supplierIndexes: combinationSupplierIndexesA,
         lastSuppliers: lastCombinationSuppliersA
     };
     
     data.combinazioneB = {
         attiva: combinationDetailsB.length > 0,
         dettagli: combinationDetailsB,
         supplierIndexes: combinationSupplierIndexesB,
         lastSuppliers: lastCombinationSuppliersB
     };
     
     return data;
 }

 // Genera anteprima di stampa con layout Excel
 function generatePrintPreview() {
     const data = collectProgramData();
     
     if (!data.tipoAgrume) {
         alert('Seleziona prima il tipo di agrume');
         return;
     }
     
     if (data.fornitori.length === 0) {
         alert('Aggiungi almeno un fornitore');
         return;
     }
     
     // Crea finestra di anteprima
     const printWindow = window.open('', '_blank', 'width=1200,height=800');
     
     const printHTML = `
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programma Trasformazione Frutta - ${data.tipoAgrume}</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 15mm;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            line-height: 1.2;
            margin: 0;
            padding: 10px;
            background: white;
        }
        
        .document-container {
            width: 100%;
            background: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            position: relative;
        }
        
        .main-title {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .document-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 11px;
        }
        
        .product-name {
            font-weight: bold;
            font-size: 12px;
        }
        
        .date-version {
            text-align: right;
        }
        
        .mod-info {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 8px;
            border: 1px solid #666;
            padding: 5px;
            background: #f9f9f9;
            line-height: 1;
        }
        
        .section {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        
        .section-title {
            background: #e6e6e6;
            padding: 8px;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            font-size: 11px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #999;
            padding: 4px 6px;
            text-align: center;
            font-size: 9px;
        }
        
        .data-table th {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .row-label {
            background: #f8f8f8;
            font-weight: bold;
            text-align: left !important;
            min-width: 120px;
        }
        
        /* Colorazioni specifiche per BIO/CONV */
        .bio-header {
            background: #90EE90 !important;
            color: #006400;
            font-weight: bold;
        }
        
        .conv-header {
            background: #FFE4B5 !important;
            color: #8B4513;
            font-weight: bold;
        }
        
        .bio-cell {
            background: #F0FFF0;
            border-left: 3px solid #90EE90;
        }
        
        .conv-cell {
            background: #FFF8DC;
            border-left: 3px solid #FFE4B5;
        }
        
        .total-column {
            background: #E6E6FA;
            font-weight: bold;
            border-left: 2px solid #4B0082;
        }
        
        .time-cell {
            font-size: 8px;
        }
        
        .combination-cell {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            font-weight: bold;
            color: #856404;
        }
        
        .notes-section {
            margin-top: 15px;
            font-size: 8px;
        }
        
        .notes-section h5 {
            font-size: 9px;
            margin-bottom: 5px;
        }
        
        @media print {
            body { font-size: 8px; }
            .data-table th, .data-table td { padding: 2px 4px; font-size: 7px; }
            .main-title { font-size: 12px; }
            .section-title { font-size: 9px; }
        }
    </style>
</head>
<body>
    <div class="document-container">
        <div class="header">
            <div class="mod-info">
                MOD 129 SQ<br/>
                REV 1<br/>
                06/12/2018
            </div>
            <h1 class="main-title">PROGRAMMA TRASFORMAZIONE FRUTTA</h1>
            <div class="document-info">
                <div class="product-name">${data.tipoAgrume}</div>
                <div class="date-version">
                    <div>${new Date(data.dataLavorazione).toLocaleDateString('it-IT')}</div>
                    <div style="margin-top: 5px;">
                        <strong>Versione:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sezione Lavorazione Frutta -->
        <div class="section">
            <div class="section-title">Lavorazione frutta</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="row-label">Frutta</th>
                        <th class="total-column">TOTALE</th>
                        <th style="width: 15px;"></th>
                        <th style="width: 15px;"></th>
                        ${generateFornitoriHeaders(data.fornitori)}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Giacenza</td>
                        <td class="total-column">0</td>
                        <td></td>
                        <td></td>
                        ${generateGiacenzaRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Entrata</td>
                        <td class="total-column">${data.entrataGiornaliera}</td>
                        <td></td>
                        <td></td>
                        ${generateEntrataRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Rimanenza</td>
                        <td class="total-column">${data.giacenzaTotale}</td>
                        <td></td>
                        <td></td>
                        ${generateRimanenzaRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Note</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generateNoteOrigineRow(data.fornitori)}
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Sezione Linee di Trasformazione -->
        <div class="section">
            <div class="section-title">Linee di trasformazione</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="row-label">Linee di trasformazione</th>
                        <th class="total-column">RIEPILOGO</th>
                        <th style="width: 15px;"></th>
                        <th style="width: 15px;"></th>
                        ${generateLineeHeaders(data.fornitori)}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Tipo frutta</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generateTipoFruttaRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Quantità</td>
                        <td class="total-column">${data.trasformataTotale}</td>
                        <td></td>
                        <td></td>
                        ${generateQuantitaRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Inizio</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generateInizioRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Portata</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generatePortataRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Fine</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generateFineRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Note</td>
                        <td class="total-column"></td>
                        <td></td>
                        <td></td>
                        ${generateNoteRow(data.fornitori)}
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Sezione Prodotti Semi-lavorati -->
        <div class="section">
            <div class="section-title">Prodotti semi-lavorati</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="row-label">Prodotto</th>
                        <th class="total-column">TOTALE</th>
                        <th style="width: 15px;"></th>
                        <th style="width: 15px;"></th>
                        ${generateProdottiHeaders(data.fornitori)}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-label">Succo 1</td>
                        <td class="total-column">${calculateTotalPrima(data.fornitori)}</td>
                        <td></td>
                        <td></td>
                        ${generateSucco1Row(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Succo 2</td>
                        <td class="total-column">${calculateTotalSeconda(data.fornitori)}</td>
                        <td></td>
                        <td></td>
                        ${generateSucco2Row(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Vasca Fiorentina</td>
                        <td class="total-column">0</td>
                        <td></td>
                        <td></td>
                        ${generateVascaRow(data.fornitori)}
                    </tr>
                    <tr>
                        <td class="row-label">Torchiato</td>
                        <td class="total-column">${calculateTotalTorchiato(data.fornitori)}</td>
                        <td></td>
                        <td></td>
                        ${generateTorchiatoRow(data.fornitori)}
                    </tr>
                </tbody>
            </table>
        </div>
        
        ${generateCombinationsNotes(data)}
        ${generateDestinationsNotes(data)}
    </div>
    
    <script>
        // Auto-stampa quando richiesto
        window.onload = function() {
            // Aggiungi pulsante stampa
            const printBtn = document.createElement('button');
            printBtn.innerHTML = 'Stampa';
            printBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;';
            printBtn.onclick = () => window.print();
            document.body.appendChild(printBtn);
        };
    </script>
</body>
</html>`;

     printWindow.document.write(printHTML);
     printWindow.document.close();
 }

 // Funzioni helper per generare le righe della tabella
 function generateFornitoriHeaders(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const headerClass = isBio ? 'bio-header' : 'conv-header';
         return `<th class="${headerClass}">${isBio ? 'BIO' : 'CONV'}</th>`;
     }).join('');
 }

 function generateGiacenzaRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">0</td>`;
     }).join('');
 }

 function generateEntrataRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.quantitaEntrata}</td>`;
     }).join('');
 }

 function generateRimanenzaRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.giacenza}</td>`;
     }).join('');
 }

 function generateNoteOrigineRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         const nome = f.nome === 'ALTRO' ? f.altroNome : f.nome;
         return `<td class="${cellClass}">${f.certificazione}<br/>${nome}</td>`;
     }).join('');
 }

 function generateLineeHeaders(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const headerClass = isBio ? 'bio-header' : 'conv-header';
         return `<th class="${headerClass}">${f.lineaTrasformazione}</th>`;
     }).join('');
 }

 function generateTipoFruttaRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${isBio ? 'BIO' : 'CONV'}</td>`;
     }).join('');
 }

 function generateQuantitaRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.quantitaTrasformata}</td>`;
     }).join('');
 }

 function generateInizioRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell time-cell' : 'conv-cell time-cell';
         return `<td class="${cellClass}">${f.orarioInizio || '--'}</td>`;
     }).join('');
 }

 function generatePortataRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.portataImpianto}</td>`;
     }).join('');
 }

 function generateFineRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell time-cell' : 'conv-cell time-cell';
         return `<td class="${cellClass}">${f.orarioFine || '--'}</td>`;
     }).join('');
 }

 function generateNoteRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.certificazione}</td>`;
     }).join('');
 }

 function generateProdottiHeaders(fornitori) {
     return fornitori.map((f, index) => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const headerClass = isBio ? 'bio-header' : 'conv-header';
         return `<th class="${headerClass}">F${index + 1}</th>`;
     }).join('');
 }

 function generateSucco1Row(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         let cellClass = isBio ? 'bio-cell' : 'conv-cell';
         if (f.isCombinationResult) {
             cellClass += ' combination-cell';
         }
         return `<td class="${cellClass}">${f.quantitaPrima}</td>`;
     }).join('');
 }

 function generateSucco2Row(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         const quantita = f.lineaTrasformazione === 'BOE/1100' ? f.quantitaSeconda : '0';
         return `<td class="${cellClass}">${quantita}</td>`;
     }).join('');
 }

 function generateVascaRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">0</td>`;
     }).join('');
 }

 function generateTorchiatoRow(fornitori) {
     return fornitori.map(f => {
         const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(f.certificazione);
         const cellClass = isBio ? 'bio-cell' : 'conv-cell';
         return `<td class="${cellClass}">${f.quantitaTorchiato}</td>`;
     }).join('');
 }

 function calculateTotalPrima(fornitori) {
     return fornitori.reduce((total, f) => total + f.quantitaPrima, 0).toFixed(1);
 }

 function calculateTotalSeconda(fornitori) {
     return fornitori.reduce((total, f) => total + (f.lineaTrasformazione === 'BOE/1100' ? f.quantitaSeconda : 0), 0).toFixed(1);
 }

 function calculateTotalTorchiato(fornitori) {
     return fornitori.reduce((total, f) => total + f.quantitaTorchiato, 0).toFixed(1);
 }

 function generateCombinationsNotes(data) {
     let notes = '';
     
     if (data.combinazioneA.attiva) {
         notes += `
         <div class="notes-section">
             <h5>Combinazione A - Succo 1ª:</h5>
             <p>${data.combinazioneA.dettagli.map(d => `F${d.supplierIndex} - ${d.nome} [${d.certificazione}|${d.linea}]: ${d.quantita}kg × ${d.resa}% = ${d.risultato}kg`).join(' + ')}</p>
         </div>`;
     }
     
     if (data.combinazioneB.attiva) {
         notes += `
         <div class="notes-section">
             <h5>Combinazione B - Succo 1ª:</h5>
             <p>${data.combinazioneB.dettagli.map(d => `F${d.supplierIndex} - ${d.nome} [${d.certificazione}|${d.linea}]: ${d.quantita}kg × ${d.resa}% = ${d.risultato}kg`).join(' + ')}</p>
         </div>`;
     }
     
     return notes;
 }

 function generateDestinationsNotes(data) {
     let notes = '<div class="notes-section"><h5>Destinazioni:</h5>';
     
     data.fornitori.forEach((f, index) => {
         const nome = f.nome === 'ALTRO' ? f.altroNome : f.nome;
         notes += `<p><strong>F${index + 1} - ${nome}:</strong> `;
         notes += `Succo 1ª → ${Array.isArray(f.destinazionePrima) ? f.destinazionePrima.join(', ') : f.destinazionePrima}`;
         if (f.lineaTrasformazione === 'BOE/1100') {
             notes += ` | Succo 2ª → ${f.destinazioneSeconda}`;
         }
         notes += ` | Torchiato → ${f.destinazioneTorchiato}</p>`;
     });
     
     notes += '</div>';
     return notes;
 }

 // Event handlers rimanenti
 $(document).on('click', '#anteprima-stampa', function() {
     generatePrintPreview();
 });

 // Altri event handlers per completare la funzionalità...
 
 // Inizializzazione
 initCurrentDate();
 
}); // Fine document ready

</script>
</body>
</html>
